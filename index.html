<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Calculadora de Ahorro & Retiro ‚Äî Christian GarBa</title>

<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=DM+Sans:wght@400;500;700&family=DM+Mono:wght@500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
  :root{
    --navy:#0A1D66;
    --electric:#1A4BFF;
    --gold:#F59E0B;
    --cream:#FFFBF5;
    --slate:#1E293B;
    --success:#10B981;
    --red:#EF4444;
    --orange:#F97316;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%;overflow:hidden}
  body{
    font-family:'DM Sans',sans-serif;
    background:var(--cream);
    color:var(--slate);
    font-size:14px;
  }

  .app-container{
    display:grid;
    grid-template-columns:380px 1fr;
    height:100vh;
    position:relative;
  }

  .control-panel{
    background:linear-gradient(180deg, var(--navy) 0%, #0D2575 100%);
    color:var(--cream);
    padding:28px 24px;
    overflow-y:auto;
    box-shadow:8px 0 24px rgba(10,29,102,.2);
    position:relative;
    z-index:10;
  }

  .logo-header{
    margin-bottom:32px;
    padding-bottom:24px;
    border-bottom:1px solid rgba(255,251,245,.15);
  }
  .logo-header img{display:block;}
  .logo-title{
    font-family:'Playfair Display',serif;
    font-size:20px;
    font-weight:900;
    letter-spacing:-.02em;
    margin-bottom:4px;
  }
  .logo-subtitle{
    font-size:12px;
    opacity:.7;
    letter-spacing:.05em;
  }

  .step-indicator{
    display:inline-block;
    width:24px;
    height:24px;
    background:var(--gold);
    color:var(--navy);
    border-radius:50%;
    text-align:center;
    line-height:24px;
    font-weight:900;
    font-size:13px;
    margin-right:8px;
  }

  .section-block{margin-bottom:28px;}
  .section-header{
    font-family:'Playfair Display',serif;
    font-size:16px;
    font-weight:700;
    margin-bottom:16px;
    color:var(--gold);
    letter-spacing:-.01em;
    display:flex;
    align-items:center;
  }

  .form-group{margin-bottom:14px;}
  .form-label{
    display:block;
    font-size:11px;
    font-weight:700;
    text-transform:uppercase;
    letter-spacing:.08em;
    margin-bottom:6px;
    opacity:.8;
  }
  .form-input{
    width:100%;
    padding:11px 14px;
    background:rgba(255,251,245,.12);
    border:1px solid rgba(255,251,245,.2);
    border-radius:6px;
    color:var(--cream);
    font-size:15px;
    font-weight:500;
    transition:all .2s;
    font-family:'DM Sans',sans-serif;
  }
  .form-input.suggested{
    background:rgba(245,158,11,.15);
    border-color:rgba(245,158,11,.4);
  }
  .form-input:focus{
    outline:none;
    background:rgba(255,251,245,.18);
    border-color:var(--gold);
    box-shadow:0 0 0 3px rgba(245,158,11,.15);
  }
  .form-input::placeholder{color:rgba(255,251,245,.4);}
  .form-hint{font-size:10px;opacity:.6;margin-top:4px;line-height:1.4;}

  .suggestion-badge{
    display:inline-block;
    background:var(--gold);
    color:var(--navy);
    padding:4px 10px;
    border-radius:4px;
    font-size:11px;
    font-weight:800;
    margin-bottom:8px;
  }

  .btn-primary{
    width:100%;
    padding:14px;
    background:var(--gold);
    color:var(--navy);
    border:none;
    border-radius:6px;
    font-weight:700;
    font-size:13px;
    text-transform:uppercase;
    letter-spacing:.08em;
    cursor:pointer;
    transition:all .25s;
    box-shadow:0 4px 12px rgba(245,158,11,.3);
    font-family:'DM Sans',sans-serif;
  }
  .btn-primary:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(245,158,11,.4);background:#FBBF24;}
  .btn-secondary{
    background:transparent;
    border:1px solid rgba(255,251,245,.3);
    color:var(--cream);
    box-shadow:none;
    margin-top:8px;
  }
  .btn-secondary:hover{background:rgba(255,251,245,.08);border-color:rgba(255,251,245,.5);}

  .collapsible-section{
    border:1px solid rgba(255,251,245,.15);
    border-radius:8px;
    margin-top:16px;
    overflow:hidden;
  }
  .collapsible-header{
    padding:12px 14px;
    background:rgba(255,251,245,.08);
    cursor:pointer;
    display:flex;
    justify-content:space-between;
    align-items:center;
    user-select:none;
  }
  .collapsible-header:hover{background:rgba(255,251,245,.12);}
  .collapsible-title{
    font-size:13px;
    font-weight:700;
    text-transform:uppercase;
    letter-spacing:.06em;
  }
  .collapsible-icon{
    transition:transform .2s;
  }
  .collapsible-header.open .collapsible-icon{
    transform:rotate(180deg);
  }
  .collapsible-content{
    display:none;
    padding:14px;
  }
  .collapsible-content.visible{
    display:block;
  }

  .error-alert{
    display:none;
    background:rgba(239,68,68,.15);
    border:1px solid rgba(239,68,68,.4);
    color:#FCA5A5;
    padding:10px 12px;
    border-radius:6px;
    font-size:12px;
    margin-bottom:12px;
    font-weight:500;
  }
  .error-alert.visible{display:block;}

  .results-panel{background:var(--cream);overflow-y:auto;position:relative;}

  .hero-section{
    background:linear-gradient(135deg, var(--navy) 0%, var(--electric) 100%);
    padding:40px 48px;
    position:relative;
    overflow:hidden;
  }
  .hero-section::before{
    content:'';
    position:absolute;top:0;right:0;width:400px;height:400px;
    background:radial-gradient(circle, rgba(245,158,11,.15) 0%, transparent 70%);
    pointer-events:none;
  }
  .hero-actions{
    position:absolute;top:20px;right:24px;display:flex;gap:10px;z-index:5;
  }
  .btn-action{
    padding:10px 18px;
    background:rgba(255,251,245,.15);
    backdrop-filter:blur(10px);
    border:1px solid rgba(255,251,245,.25);
    color:var(--cream);
    border-radius:6px;
    font-weight:700;
    font-size:12px;
    cursor:pointer;
    transition:.2s;
    text-transform:uppercase;
    letter-spacing:.05em;
  }
  .btn-action:hover{background:rgba(255,251,245,.25);transform:translateY(-1px);}
  .btn-action.accent{background:var(--gold);color:var(--navy);border-color:var(--gold);}
  .btn-action.accent:hover{background:#FBBF24;}

  .hero-grid{display:grid;grid-template-columns:1fr 1fr;gap:32px;position:relative;z-index:2;}
  .hero-label{
    font-size:11px;text-transform:uppercase;letter-spacing:.12em;
    color:rgba(255,251,245,.7);margin-bottom:8px;font-weight:700;
  }
  .hero-value{
    font-family:'Playfair Display',serif;
    font-size:52px;font-weight:900;color:var(--cream);
    line-height:1;letter-spacing:-.02em;
    text-shadow:0 2px 8px rgba(0,0,0,.1);
  }
  .hero-value.highlight{color:var(--gold);font-size:72px;}
  .hero-caption{font-size:11px;color:rgba(255,251,245,.6);margin-top:6px;}

  .stats-container{padding:32px 48px;}
  .comparison-strip{display:grid;gap:12px;margin-bottom:24px;}
  .comp-box{
    padding:16px 12px;border-radius:8px;font-size:11px;font-weight:600;text-align:center;transition:.2s;border:2px solid;
  }
  .comp-box:hover{transform:translateY(-2px);}
  .comp-box.mattress{background:linear-gradient(135deg, #FEE2E2, #FECACA);color:#991B1B;border-color:var(--red);}
  .comp-box.bank{background:linear-gradient(135deg, #FED7AA, #FDBA74);color:#9A3412;border-color:var(--orange);}
  .comp-box.plan{background:linear-gradient(135deg, #D1FAE5, #A7F3D0);color:#065F46;border-color:var(--success);box-shadow:0 4px 12px rgba(16,185,129,.25);}
  .comp-label{font-size:9px;text-transform:uppercase;letter-spacing:.08em;font-weight:800;margin-bottom:6px;}
  .comp-value{font-family:'DM Mono',monospace;font-size:16px;font-weight:500;margin:6px 0;}
  .comp-loss{font-size:10px;font-weight:700;margin-top:4px;}

  .retirement-section{display:none;background:linear-gradient(135deg,#ECFDF5 0%,#D1FAE5 100%);padding:28px 32px;border-radius:12px;border:2px solid var(--success);margin-bottom:24px;}
  .retirement-section.visible{display:block;animation:fadeIn .4s ease-out;}
  @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
  .retirement-title{font-family:'Playfair Display',serif;font-size:20px;font-weight:700;color:#065F46;margin-bottom:16px;}
  .retirement-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;}
  .retirement-item{background:white;padding:16px;border-radius:8px;border-left:4px solid var(--success);}
  .retirement-label{font-size:10px;text-transform:uppercase;letter-spacing:.08em;color:#059669;font-weight:700;margin-bottom:6px;}
  .retirement-value{font-family:'DM Mono',monospace;font-size:22px;font-weight:500;color:#065F46;}

  .detail-wrapper{background:white;padding:24px 32px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.06);margin-bottom:20px;}
  .detail-toggle{display:flex;justify-content:space-between;align-items:center;cursor:pointer;font-weight:700;color:var(--navy);font-size:14px;user-select:none;}
  .detail-toggle:hover{color:var(--electric);}
  .detail-toggle .icon{transition:transform .2s;}
  .detail-toggle.open .icon{transform:rotate(180deg);}
  .detail-content{display:none;margin-top:16px;max-height:240px;overflow-y:auto;}
  .detail-content.visible{display:block;animation:slideDown .3s ease-out;}
  @keyframes slideDown{from{opacity:0;max-height:0}to{opacity:1;max-height:240px}}
  table{width:100%;border-collapse:collapse;font-size:12px;}
  th{background:var(--navy);color:white;text-align:left;padding:10px 12px;font-weight:700;text-transform:uppercase;letter-spacing:.05em;font-size:11px;}
  td{padding:10px 12px;border-bottom:1px solid #E2E8F0;}
  tr:hover{background:#F8FAFC;}
  tr:last-child td{border-bottom:none;}

  .chart-section{background:white;padding:32px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.06);margin-bottom:24px;}
  .chart-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;}
  .chart-title{font-family:'Playfair Display',serif;font-size:20px;font-weight:700;color:var(--navy);}
  .chart-badge{background:linear-gradient(135deg, var(--electric), #3B82F6);color:white;padding:6px 14px;border-radius:20px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.05em;}
  #chartCanvas{max-height:280px;}

  .whatsapp-float{position:fixed;right:28px;bottom:28px;background:#25D366;color:white;padding:16px 24px;border-radius:50px;font-weight:700;font-size:14px;box-shadow:0 8px 24px rgba(37,211,102,.35);cursor:pointer;transition:.3s;z-index:100;text-decoration:none;display:flex;align-items:center;gap:8px;}
  .whatsapp-float:hover{transform:scale(1.05);box-shadow:0 12px 32px rgba(37,211,102,.5);}

  ::-webkit-scrollbar{width:8px;height:8px}
  ::-webkit-scrollbar-track{background:rgba(0,0,0,.05)}
  ::-webkit-scrollbar-thumb{background:var(--electric);border-radius:4px}
  ::-webkit-scrollbar-thumb:hover{background:var(--navy)}

  /* PDF styles omitted for brevity in this snippet; kept in file exactly as provided in prior version */
  .report-view{display:none}
  @media print{
    body{-webkit-print-color-adjust:exact;print-color-adjust:exact;overflow:visible}
    html,body{height:auto;overflow:visible}
    .app-container,.whatsapp-float{display:none !important}
    .report-view{display:block !important;max-width:800px;margin:0 auto;padding:15mm}
  }
</style>
</head>
<body>

<div class="app-container">
  <div class="control-panel">
    <div class="logo-header">
      <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
        <img src="./logo-garba.png" alt="Christian GarBa" style="height:44px;width:auto;filter:brightness(0) invert(1)">
        <div style="width:1px;height:40px;background:rgba(255,251,245,.2)"></div>
        <img src="./logo-allianz.png" alt="Allianz" style="height:36px;width:auto;filter:brightness(0) invert(1)">
      </div>
      <div class="logo-title">Christian GarBa</div>
      <div class="logo-subtitle">Seguros con Estrategia ¬∑ Allianz</div>
      <div style="font-size:11px;opacity:.7;margin-top:8px;letter-spacing:.03em">üìû 662 307 2573</div>
    </div>

    <div class="section-block">
      <div class="section-header"><span class="step-indicator">1</span>Tus Datos</div>

      <div class="form-group">
        <label class="form-label">Tu nombre (opcional)</label>
        <input class="form-input" id="nombreOpt" type="text" placeholder="Ej. Fernanda">
      </div>

      <div class="form-group">
        <label class="form-label">Edad actual</label>
        <input class="form-input" id="edad" type="number" min="18" max="100" value="29">
      </div>

      <div class="form-group">
        <label class="form-label">A√±os que aportar√°s</label>
        <input class="form-input" id="years" type="number" value="25" min="1" max="70">
      </div>

      <div class="form-group">
        <label class="form-label">Meta mensual deseada (valor de hoy)</label>
        <input class="form-input" id="metaHoy" type="number" min="0" step="1000" value="32000">
      </div>
    </div>

    <div class="section-block">
      <div class="section-header"><span class="step-indicator">2</span>Tu Aportaci√≥n</div>

      <div class="error-alert" id="errorMsg"></div>

      <div class="form-group">
        <label class="form-label">
          <span class="suggestion-badge" id="suggestedBadge" style="display:none">üí° Sugerido</span>
          Aportaci√≥n mensual
        </label>
        <input class="form-input" id="pmt" type="number" value="2500" min="0" step="0.01">
        <div class="form-hint" id="pmtHint">Calcula tu plan para ver la aportaci√≥n sugerida</div>
      </div>

      <div class="form-group">
        <label class="form-label">Frecuencia</label>
        <select class="form-input" id="frequency">
          <option value="12" selected>Mensual</option>
          <option value="4">Trimestral</option>
          <option value="2">Semestral</option>
          <option value="1">Anual</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label">Aportaci√≥n √∫nica inicial</label>
        <input class="form-input" id="lumpSum" type="number" value="0" min="0" step="0.01">
      </div>

      <div class="form-group">
        <label class="form-label">R√©gimen fiscal</label>
        <select class="form-input" id="regimenFiscal">
          <option value="ninguno">Sin beneficio fiscal</option>
          <option value="93">Art. 93 (diferido)</option>
          <option value="151">Art. 151 (deducible)</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label">Devoluci√≥n ISR (%)</label>
        <select class="form-input" id="isrPct">
          <option value="0">0%</option>
          <option value="10">10%</option>
          <option value="20" selected>20%</option>
          <option value="30">30%</option>
          <option value="35">35%</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label" style="display:flex;align-items:center;gap:8px">
          <input id="reinvertISR" type="checkbox" checked style="width:auto;margin:0">
          Reinvertir devoluci√≥n fiscal
        </label>
      </div>

      <div class="collapsible-section">
        <div class="collapsible-header" id="advancedToggle">
          <span class="collapsible-title">‚öôÔ∏è Par√°metros Avanzados</span>
          <span class="collapsible-icon">‚ñº</span>
        </div>
        <div class="collapsible-content" id="advancedContent">
          <div class="form-group">
            <label class="form-label">Rendimiento esperado (%)</label>
            <input class="form-input" id="rate" type="number" value="10" min="0" max="100" step="0.01">
          </div>
          <div class="form-group">
            <label class="form-label">Inflaci√≥n promedio (%)</label>
            <input class="form-input" id="inflation" type="number" value="4" min="0" max="100" step="0.01">
          </div>
        </div>
      </div>

      <button class="btn-primary" id="calcBtn" style="margin-top:16px">Calcular Proyecci√≥n</button>
      <button class="btn-primary btn-secondary" id="resetBtn">Reiniciar Todo</button>
    </div>

    <div class="section-block">
      <div class="section-header"><span class="step-indicator">3</span>Tu Retiro</div>

      <input type="hidden" id="pvRet" value="0">

      <div class="form-group">
        <label class="form-label">A√±os de retiro</label>
        <select class="form-input" id="yrsRetSel">
          <option value="15">15 a√±os</option>
          <option value="20" selected>20 a√±os</option>
          <option value="25">25 a√±os</option>
        </select>
      </div>

      <button class="btn-primary" id="calcRet">Calcular Mensualidad</button>
    </div>

  </div>

  <div class="results-panel">
    <div class="hero-section">
      <div class="hero-actions">
        <button class="btn-action" id="csvBtn">CSV</button>
        <button class="btn-action accent" id="printBtn">Generar PDF</button>
      </div>

      <div class="hero-grid">
        <div>
          <div class="hero-label">Fondo a los 65 a√±os</div>
          <div class="hero-value highlight" id="fondo65">‚Äî</div>
          <div class="hero-caption">Proyecci√≥n con rendimientos (aportaci√≥n hasta 65)</div>
        </div>
        <div>
          <div class="hero-label">Total aportado</div>
          <div class="hero-value" id="totalAportado">‚Äî</div>
          <div class="hero-caption">De tu bolsillo</div>
        </div>
        <div>
          <div class="hero-label">Rendimiento generado</div>
          <div class="hero-value" id="rendimiento">‚Äî</div>
        </div>
        <div>
          <div class="hero-label">Ahorro al finalizar aportaci√≥n</div>
          <div class="hero-value" id="ahorroNominal">‚Äî</div>
          <div class="hero-caption">A tu edad: <span id="edadFinal">‚Äî</span></div>
        </div>
      </div>
    </div>

    <div class="stats-container">
      <div style="margin-bottom:24px">
        <div style="font-family:'Playfair Display',serif;font-size:22px;font-weight:700;color:var(--navy);margin-bottom:16px;text-align:center">
          ¬øD√≥nde est√° tu dinero en <span id="compYears">‚Äî</span> a√±os?
        </div>
        <div class="comparison-strip" style="grid-template-columns:repeat(4,1fr);gap:10px">
          <div class="comp-box mattress">
            <div class="comp-label">üí∏ COLCH√ìN</div>
            <div class="comp-value" id="compMattress">‚Äî</div>
            <div style="margin:8px 0"><div style="background:#DC2626;height:8px;border-radius:4px;width:20%"></div></div>
            <div class="comp-loss" id="compMattressLoss">‚Äî</div>
          </div>
          <div class="comp-box bank">
            <div class="comp-label">üè¶ BANCO</div>
            <div class="comp-value" id="compBank">‚Äî</div>
            <div style="margin:8px 0"><div style="background:#EA580C;height:8px;border-radius:4px;width:24%"></div></div>
            <div class="comp-loss" id="compBankLoss">‚Äî</div>
          </div>
          <div class="comp-box" style="background:linear-gradient(135deg,#FEF3C7,#FDE68A);color:#92400E;border-color:#F59E0B">
            <div class="comp-label">üèõÔ∏è AFORE</div>
            <div class="comp-value" id="compAfore">‚Äî</div>
            <div style="margin:8px 0"><div style="background:#F59E0B;height:8px;border-radius:4px;width:38%"></div></div>
            <div class="comp-loss" id="compAforeLoss">‚Äî</div>
          </div>
          <div class="comp-box plan">
            <div class="comp-label">‚ú® TU PLAN</div>
            <div class="comp-value" id="compPlan">‚Äî</div>
            <div style="margin:8px 0"><div style="background:#10B981;height:8px;border-radius:4px;width:100%"></div></div>
            <div class="comp-loss" style="color:#065F46">‚úì Protegido</div>
          </div>
        </div>
      </div>

      <div class="chart-section">
        <div class="chart-header">
          <div class="chart-title">Proyecci√≥n de Crecimiento</div>
          <div class="chart-badge">Interactivo</div>
        </div>
        <canvas id="chartCanvas"></canvas>
      </div>

      <div class="retirement-section" id="retBox">
        <div class="retirement-title">Tu Ingreso Mensual en Retiro</div>
        <div class="retirement-grid">
          <div class="retirement-item"><div class="retirement-label">Ingreso mensual</div><div class="retirement-value" id="pmtReal">‚Äî</div></div>
          <div class="retirement-item"><div class="retirement-label">Meses de retiro</div><div class="retirement-value" id="nMeses">‚Äî</div></div>
          <div class="retirement-item"><div class="retirement-label">Tasa real mensual</div><div class="retirement-value" id="iRealMes">‚Äî</div></div>
          <div class="retirement-item"><div class="retirement-label">Regla 4% anual</div><div class="retirement-value" id="rule4">‚Äî</div></div>
        </div>
      </div>

      <div class="detail-wrapper">
        <div class="detail-toggle" id="toggleTable"><span>üìä Detalles a√±o por a√±o</span><span class="icon">‚ñº</span></div>
        <div class="detail-content" id="details">
          <table><thead><tr><th>A√±o</th><th>Edad</th><th>Aportado</th><th>Beneficio fiscal</th><th>Saldo</th></tr></thead><tbody id="tbody"></tbody></table>
        </div>
      </div>

      <div class="detail-wrapper">
        <div class="detail-toggle" id="toggleTableRet"><span>üìã Detalle mensual del retiro</span><span class="icon">‚ñº</span></div>
        <div class="detail-content" id="detailsRet">
          <table><thead><tr><th>Mes</th><th>Edad</th><th>Retiro</th><th>Inter√©s</th><th>Saldo</th></tr></thead><tbody id="tbodyRet"></tbody></table>
        </div>
      </div>

    </div>
  </div>
</div>

<a id="waBtn" class="whatsapp-float" target="_blank" rel="noopener"><span>üí¨</span> WhatsApp</a>

<div class="report-view"></div>

<script>
  const $ = id => document.getElementById(id);
  const money = v => new Intl.NumberFormat('es-MX',{style:'currency',currency:'MXN',minimumFractionDigits:0,maximumFractionDigits:0}).format(Number(v)||0);
  const freqMap = {'12':'Mensual','4':'Trimestral','2':'Semestral','1':'Anual'};

  let myChart = null;
  let userEditedPMT = false;
  const reportState = { yearsEff:null };

  function linkWhatsApp(){
    const nombre = ($('nombreOpt').value||'').trim();
    const msg = [
      'Hola Christian, me interesa revisar mi plan de retiro.',
      nombre?('Soy '+nombre+'.'):'',
      '*Datos:*',
      `‚Ä¢ Edad: ${$('edad').value} a√±os`,
      `‚Ä¢ A√±os de aportaci√≥n: ${$('years').value}`,
      `‚Ä¢ Aportaci√≥n ${freqMap[$('frequency').value]}: $${$('pmt').value}`
    ].filter(Boolean).join('\\n');
    $('waBtn').href = 'https://wa.me/526623072573?text='+encodeURIComponent(msg);
  }

  function calcularPMTRequerido(edadInicio, planY, metaHoy, infl, rAcc, rRet, yrsRet, freq){
    if(!(edadInicio>0 && planY>0 && metaHoy>0)) return 0;
    const yrsTo65=Math.max(0,65-edadInicio);
    const yrsAport=Math.min(planY,yrsTo65);
    const gapYears=Math.max(0,yrsTo65-yrsAport);
    if(yrsAport<=0)return 0;
    const inflDec=infl/100,rAccDec=rAcc/100,rRetDec=rRet/100;
    const metaNom65=metaHoy*Math.pow(1+inflDec,yrsTo65);
    const iRet=rRetDec/freq,nRet=yrsRet*freq;
    const PVneed65=Math.abs(iRet)<1e-12?metaNom65*nRet:metaNom65*((1-Math.pow(1+iRet,-nRet))/iRet);
    const iAcc=rAccDec/freq,N=yrsAport*freq;
    let FV_pagos=0,pmtYear=1;
    for(let y=0;y<yrsAport;y++){
      if(y>0)pmtYear*=(1+inflDec);
      for(let m=0;m<freq;m++){
        const perRest=N-(y*freq+m);
        FV_pagos+=pmtYear*Math.pow(1+iAcc,perRest);
      }
    }
    const growTo65=Math.pow(1+iAcc,gapYears*freq);
    const totalFactor=FV_pagos*growTo65;
    return totalFactor<=0?0:PVneed65/totalFactor;
  }

  function updateSuggestion(){
    const edad=parseFloat($('edad').value);
    const planY=parseFloat($('years').value);
    const metaHoy=parseFloat($('metaHoy').value||0);
    const infl=parseFloat($('inflation').value);
    const rAcc=parseFloat($('rate').value);
    const rRet=7;
    const yrsRet=parseInt($('yrsRetSel').value||20,10);
    const freq=12;

    if(!(edad>0&&planY>0&&metaHoy>0)) return;

    const pmt0=calcularPMTRequerido(edad,planY,metaHoy,infl,rAcc,rRet,yrsRet,freq);

    if(!userEditedPMT){
      $('pmt').value=String(pmt0.toFixed(2));
      $('pmt').classList.add('suggested');
    }
    $('suggestedBadge').style.display='inline-block';
    $('pmtHint').innerHTML=`üí° Sugerido: <strong>${money(pmt0)}</strong> para alcanzar tu meta`;
  }

  function actualizarGrafica(labels,data){
    const ctx=$('chartCanvas').getContext('2d');
    if(myChart)myChart.destroy();
    myChart=new Chart(ctx,{
      type:'line',
      data:{labels,datasets:[{label:'Fondo',data,fill:true,tension:0.4,borderWidth:3,pointRadius:0}]},
      options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
    });
  }

  function calcAccum(){
    const edad=parseFloat($('edad').value);
    const yearsInput=parseFloat($('years').value);
    const pmt0=parseFloat($('pmt').value);
    const lump=parseFloat($('lumpSum').value);
    const rate=parseFloat($('rate').value)/100;
    const freq=parseFloat($('frequency').value);
    const infl=parseFloat($('inflation').value)/100;

    const yrsTo65 = Math.max(0, 65 - edad);
    const yrsAport = Math.min(yearsInput, yrsTo65);
    const yrsExtra = Math.max(0, yrsTo65 - yrsAport);

    reportState.yearsEff = yrsAport;
    $('compYears').textContent = yrsAport ? String(Math.round(yrsAport)) : '‚Äî';

    if(yearsInput > yrsTo65 && yrsTo65 > 0){
      $('errorMsg').textContent=`‚ÑπÔ∏è Tu plazo excede los 65. Se ajust√≥ a ${Math.round(yrsAport)} a√±os de aportaci√≥n (hasta los 65).`;
      $('errorMsg').classList.add('visible');
    } else {
      $('errorMsg').classList.remove('visible');
    }

    const i=rate/freq;
    let saldo=lump,totalAportado=lump,fvEndPlan=lump,edadAct=edad,pmtYear=pmt0;

    const tbody=$('tbody'); tbody.innerHTML='';
    const chartLabels=[], chartData=[];
    const totalYearsSim=yrsAport+yrsExtra;

    for(let yr=1;yr<=totalYearsSim;yr++){
      edadAct++;
      let aportAno=0;
      if(yr<=yrsAport){
        if(yr>1)pmtYear*=(1+infl);
        for(let k=0;k<freq;k++){
          saldo*=(1+i);
          saldo+=pmtYear;
          aportAno+=pmtYear;
          totalAportado+=pmtYear;
        }
      } else {
        for(let k=0;k<freq;k++) saldo*=(1+i);
      }
      if(yr===yrsAport) fvEndPlan=saldo;

      chartLabels.push(`A√±o ${yr}`);
      chartData.push(saldo);

      const tr=document.createElement('tr');
      if(yr>yrsAport) tr.style.background='rgba(148,163,184,.08)';
      tr.innerHTML=`<td>${yr}</td><td>${Math.round(edadAct)}</td><td>${yr>yrsAport?'‚Äî':money(aportAno)}</td><td>‚Äî</td><td>${money(saldo)}</td>`;
      tbody.appendChild(tr);
    }

    $('edadFinal').textContent=String(Math.round(edad+yrsAport));
    $('ahorroNominal').textContent=money(fvEndPlan);
    $('totalAportado').textContent=money(totalAportado);
    $('rendimiento').textContent=money(fvEndPlan-totalAportado);
    $('fondo65').textContent=money(saldo);
    $('pvRet').value=String(saldo);

    // Comparativa basada en yearsEff
    const totalMeses = yrsAport * 12;
    const aportMensual = pmt0;
    const colchonNominal = totalMeses * aportMensual;
    const colchonReal = yrsAport>0 ? (colchonNominal / Math.pow(1+infl, yrsAport)) : 0;

    const iBanco = 0.02/12;
    let saldoBanco=0;
    for(let m=0;m<totalMeses;m++){ saldoBanco*=(1+iBanco); saldoBanco+=aportMensual; }
    const bancoReal = yrsAport>0 ? (saldoBanco / Math.pow(1+infl, yrsAport)) : 0;

    const iAfore=0.09/12;
    let saldoAfore=0;
    for(let m=0;m<totalMeses;m++){ saldoAfore*=(1+iAfore); saldoAfore+=aportMensual; }

    $('compMattress').textContent=money(colchonNominal);
    $('compMattressLoss').textContent=`Vale: ${money(colchonReal)}`;
    $('compBank').textContent=money(saldoBanco);
    $('compBankLoss').textContent=`Vale: ${money(bancoReal)}`;
    $('compAfore').textContent=money(saldoAfore);
    $('compAforeLoss').textContent=`Pensi√≥n limitada`;
    $('compPlan').textContent=money(saldo);

    actualizarGrafica(chartLabels,chartData);
    linkWhatsApp();
  }

  function calcRet(){
    const PV=parseFloat($('pvRet').value)||0;
    const yrs=parseInt($('yrsRetSel').value,10);
    const rateRet=7/100;
    const infl=4/100;
    if(PV<=0){alert('‚ö†Ô∏è Primero calcula tu ahorro.');return;}
    const iNom=rateRet/12;
    const n=yrs*12;
    const PMT=Math.abs(iNom)<1e-9?PV/n:PV*(iNom/(1-Math.pow(1+iNom,-n)));
    const rReal=((1+rateRet)/(1+infl))-1;
    const iReal=rReal/12;

    $('retBox').classList.add('visible');
    $('pmtReal').textContent=money(PMT);
    $('nMeses').textContent=`${n}`;
    $('iRealMes').textContent=`${(iReal*100).toFixed(3)}%`;
    $('rule4').textContent=`${money(PV*0.04)} /a√±o`;
  }

  $('pmt').addEventListener('input',()=>{ userEditedPMT=true; $('pmt').classList.remove('suggested'); });

  $('calcBtn').addEventListener('click',()=>{ updateSuggestion(); calcAccum(); });
  $('resetBtn').addEventListener('click',()=>{
    $('nombreOpt').value='';
    $('edad').value=29;
    $('years').value=25;
    $('metaHoy').value=32000;
    $('pmt').value=2500;
    userEditedPMT=false;
    $('frequency').value=12;
    $('lumpSum').value=0;
    $('rate').value=10;
    $('inflation').value=4;
    updateSuggestion();
    calcAccum();
  });
  $('calcRet').addEventListener('click',calcRet);

  $('advancedToggle').addEventListener('click',function(){
    $('advancedContent').classList.toggle('visible');
    this.classList.toggle('open');
  });
  $('toggleTable').addEventListener('click',function(){
    $('details').classList.toggle('visible');
    this.classList.toggle('open');
  });
  $('toggleTableRet').addEventListener('click',function(){
    $('detailsRet').classList.toggle('visible');
    this.classList.toggle('open');
  });

  window.addEventListener('load',()=>{ updateSuggestion(); calcAccum(); linkWhatsApp(); });
</script>
</body>
</html>
